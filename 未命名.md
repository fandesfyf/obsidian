## 开发任务模板

### 1. 功能/算法描述

- 目前单步控制无法控制轨迹细节(如指定腾空相末端轨迹、多段躯干轨迹、关节速度参考等)，需要添加MPC全身轨迹执行的接口
- 

### 2. 实施方案

- 实现步骤
  1. 定义一个新的消息类型，传递包含接触状态的全身q、v、以及对应对的高频接触相，到SwitchedModelReferenceManager模块
  2. 由原始轨迹点按照mode划分出mode，并且由drake的广义位置速度生成ocs2中的state和input轨迹，生成targetTrajectories
  3. 定义新的数据类型，传递mode序列、对应的state轨迹到GaitSchedule，mode_schedule传递到swingplanner
  4. 由swingplanner对截取的一段时间的 mode_schedule 进行正解求末端轨迹
  5. SwitchedModelReferenceManager中，进行躯干规划，暂时直接使用传入的全身的targetTrajectories尝试跟踪
  6. 修改PreComputation模块，传递关节层的速度项到HumanoidStateInputQuadraticCost设置到input进行跟踪(尝试）


- 涉及的模块改动
  - SwitchedModelReferenceManager模块
	  - 增加ros订阅
	  - 增加qv的解析，生成全身targetTrajectories
	  - 并且需要兼容旧实现，包括不影响手臂的简化自由度
- ModeSchedule
	- 增加传递的全身数据类型
		- 精细时间戳
		- 对应的state规划值
		- 对应的全身规划标志位
- SwingTrajectoryPlanner
	- 增加正解模块
	- 轨迹规划修改，逐段腾空相插值
	- 插值器修改，高频的足端规划需要形状保持的插值器
	- 兼容旧的实现
- 新增一个发布轨迹的脚本，python实现读取csv并通过rostopic发布即可
  - <!-- 如果是新增的案例、测试用例等，需要说明现有接口、需要新增或者改动的接口、工具(使用的语言、新增库等)等 -->
  - <!-- 如果是对现有案例的修改，需要说明改动前后的区别和影响 -->
  - <!-- 尽量具体到功能模块文件 -->


### 3. 预期耗时
<!-- 请估计完成该任务所需的时间
如果预计耗时>=4h，需要组长/项目负责人确认后方可开发
-->
- 2 天
- 

### 4. 预计的难点
<!-- 列出可能遇到的技术难点或挑战 -->
- 全身轨迹跟踪非常依赖外部轨迹质量
- 和单步控制不一样，全身轨迹跟踪直接使用外部给的轨迹，但是现在动捕映射的轨迹都站的很高，使用单步接口时是指定相对高度，但是如果直接执行全身轨迹，可能会站太直而难站稳
- 手臂简化自由度导致手臂无法一起处理，单步的接口实现是单独通过手臂的外部接口实现的控制，直接在mpc内部处理需要注意广义位置速度中手臂的简化自由度
- 对轨迹接触相稳定性非常敏感
### 5. @相关人员、issue
<!-- @需要知会或确认的相关人员或者相关issue -->


